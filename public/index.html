<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic-Oid | The Magic Detective</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
    body { font-family: 'Poppins', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #4c1d95 0%, #8b5cf6 100%); }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="gradient-bg min-h-screen text-slate-800 p-4">

  <div class="max-w-2xl mx-auto">
    
    <header class="text-center text-white mb-8 pt-4">
      <div class="text-6xl mb-2">üé©</div>
      <h1 class="text-4xl font-bold mb-2">Magic-Oid</h1>
      <p class="opacity-90">Identify Tricks ‚Ä¢ Value Collections ‚Ä¢ Roast Magicians</p>
      
      <div class="flex justify-center gap-4 mt-6 text-sm font-bold">
        <a href="/dealers.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full transition">
          ü§ù Become a Dealer
        </a>
        <a href="https://buymeacoffee.com/chrispteemagician" target="_blank" class="bg-yellow-400 hover:bg-yellow-500 text-black px-4 py-2 rounded-full transition">
          ‚òï Buy Chris a Coffee
        </a>
      </div>
    </header>

    <main class="glass rounded-3xl p-6 shadow-2xl relative overflow-hidden">
      
      <div class="absolute top-4 right-4 bg-slate-100 px-3 py-1 rounded-full text-xs font-bold text-slate-500">
        <span id="creditCount">3</span> Free Credits Left
      </div>

      <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
        <button onclick="setMode('identify')" id="btn-identify" class="flex-1 py-3 rounded-lg font-bold transition bg-white shadow text-purple-700">
          üîÆ Identify
        </button>
        <button onclick="setMode('roast')" id="btn-roast" class="flex-1 py-3 rounded-lg font-bold transition text-slate-500 hover:text-orange-500">
          üî• Roast Me
        </button>
      </div>

      <div onclick="document.getElementById('fileInput').click()" 
           class="border-4 border-dashed border-purple-200 hover:border-purple-400 bg-purple-50 rounded-2xl p-8 text-center cursor-pointer transition group">
        <div class="text-5xl mb-4 group-hover:scale-110 transition transform">üì∏</div>
        <h3 class="text-xl font-bold text-purple-900 mb-1">Tap to Analyze</h3>
        <p class="text-purple-600 text-sm">Take a photo or choose from gallery</p>
      </div>
      <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleUpload(this)">

      <div id="loading" class="hidden text-center py-12">
        <div class="animate-spin text-4xl mb-4">ü™Ñ</div>
        <p class="font-bold text-purple-700 animate-pulse">Consulting the Oracle...</p>
      </div>

      <div id="result" class="hidden mt-8 prose prose-purple max-w-none">
        </div>

      <div id="dealerCTA" class="hidden mt-8 pt-6 border-t border-slate-200 text-center">
        <p class="text-sm text-slate-500 mb-3">Want unlimited scans? Support the magic community.</p>
        <a href="/dealers.html" class="inline-block bg-slate-800 text-white px-6 py-3 rounded-xl font-bold">
          See Dealer Plans
        </a>
      </div>

    </main>
    
    <footer class="text-center text-white/60 text-xs mt-8 pb-8">
      <p class="mb-2">Built by Chris P Tee (The Tech Wizard)</p>
      <a href="/privacy.html" class="underline hover:text-white">Privacy Policy</a> ‚Ä¢ No data stored on server
    </footer>

  </div>

  <script>
    // --- SPICYLISTER LOGIC ENGINE ---
    let currentMode = 'identify';
    let credits = parseInt(localStorage.getItem('magic_credits') || '3');

    // Update UI on load
    document.getElementById('creditCount').textContent = credits;

    function setMode(mode) {
      currentMode = mode;
      // Toggle button styles
      document.getElementById('btn-identify').className = mode === 'identify' 
        ? 'flex-1 py-3 rounded-lg font-bold transition bg-white shadow text-purple-700'
        : 'flex-1 py-3 rounded-lg font-bold transition text-slate-500 hover:text-purple-700';
      
      document.getElementById('btn-roast').className = mode === 'roast'
        ? 'flex-1 py-3 rounded-lg font-bold transition bg-white shadow text-orange-600'
        : 'flex-1 py-3 rounded-lg font-bold transition text-slate-500 hover:text-orange-600';
    }

    async function handleUpload(input) {
      const file = input.files[0];
      if (!file) return;

      // Check Credits
      if (credits <= 0) {
        alert("üîí You're out of free credits! Visit the Dealer page or Buy a Coffee to unlock more.");
        return;
      }

      // UI Updates
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('result').classList.add('hidden');
      document.getElementById('dealerCTA').classList.add('hidden');

      try {
        const base64 = await toBase64(file);
        
        const response = await fetch('/api/analyze-magic', {
          method: 'POST',
          body: JSON.stringify({ image: { data: base64 }, mode: currentMode })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        // Render Result
        document.getElementById('result').innerHTML = marked.parse(data.result);
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('dealerCTA').classList.remove('hidden');

        // Deduct Credit (SpicyLister Logic)
        credits--;
        localStorage.setItem('magic_credits', credits);
        document.getElementById('creditCount').textContent = credits;

      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
        input.value = '';
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }
  </script>
</body>
</html>